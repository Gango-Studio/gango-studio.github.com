<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高精度兼容节拍器</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f5f5f5;
            font-family: Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        .wheel-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 30px;
        }

        .control-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            box-shadow: 8px 8px 16px #d9d9d9,
                      -8px -8px 16px #ffffff;
            cursor: pointer;
            touch-action: none;
            transition: transform 0.1s ease-out;
        }

        .center-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background: #f8f8f8;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 3px 3px 6px #d9d9d9,
                      inset -3px -3px 6px #ffffff;
        }

        #bpm {
            font-size: 1.8em;
            font-weight: bold;
            color: #444;
        }

        button {
            margin: 20px;
            padding: 12px 30px;
            font-size: 1.1em;
            cursor: pointer;
            background: #f0f0f0;
            border: none;
            border-radius: 25px;
            box-shadow: 4px 4px 8px #d9d9d9,
                      -4px -4px 8px #ffffff;
            color: #444;
            transition: all 0.2s ease;
        }

        button:active {
            box-shadow: inset 2px 2px 4px #d9d9d9,
                      inset -2px -2px 4px #ffffff;
        }
    </style>
</head>
<body>
    <br/>
    <br/>
    <div class="wheel-container">
        <div class="control-wheel"></div>
        <div class="center-display">
            <span id="bpm">120</span>
            <span>BPM</span>
        </div>
    </div>
    <button id="toggle">Start</button>
        <br/>
        <script>
        // 配置项
        const CONFIG = {
            minBpm: 30,
            maxBpm: 300,
            baseBpm: 120,
            lookAhead: 0.1,    // 预排时间（秒）
            scheduleAhead: 0.2 // 调度提前量
        };

        // 状态管理
        let state = {
            isPlaying: false,
            rotation: 0,
            bpm: CONFIG.baseBpm,
            nextTickTime: 0,
            audioContext: null,
            audioBuffer: null,
            timerID: 0,
            lastTick: 0,
            useWebAudio: false
        };

        // 初始化音频
        async function initAudio() {
            try {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const response = await fetch('metronome.wav');
                const arrayBuffer = await response.arrayBuffer();
                state.audioBuffer = await state.audioContext.decodeAudioData(arrayBuffer);
                state.useWebAudio = true;
            } catch (e) {
                console.log('使用兼容音频模式');
                state.useWebAudio = false;
            }
        }

        // 音频播放
        function playTick() {
            if (state.useWebAudio) {
                const source = state.audioContext.createBufferSource();
                source.buffer = state.audioBuffer;
                source.connect(state.audioContext.destination);
                source.start(state.audioContext.currentTime);
            } else {
                const audio = new Audio('metronome.wav');
                audio.play().catch(() => {});
            }
        }

        // 核心调度器
        function scheduler() {
            if (!state.isPlaying) return;

            const now = performance.now();
            const interval = 60000 / state.bpm;
            const drift = now - state.nextTickTime;

            // 误差补偿算法
            if (drift > interval * 1.5) {
                state.nextTickTime = now;
            } else {
                state.nextTickTime += interval - Math.min(drift, interval/2);
            }

            // 节拍触发
            if (now >= state.nextTickTime - CONFIG.scheduleAhead) {
                playTick();
                state.lastTick = now;
            }

            // 动态调整请求周期
            const nextInterval = Math.max(1, interval/2 - (now - state.lastTick));
            state.timerID = setTimeout(scheduler, nextInterval);
        }

        // BPM控制（保持原有旋转逻辑）
        function updateBpm(newBpm) {
            state.bpm = Math.max(CONFIG.minBpm, Math.min(CONFIG.maxBpm, newBpm));
            document.getElementById('bpm').textContent = state.bpm;
        }

        // 控制切换
        function toggleMetronome() {
            state.isPlaying = !state.isPlaying;
            document.getElementById('toggle').textContent = state.isPlaying ? 'Stop' : 'Start';
            
            if (state.isPlaying) {
                state.nextTickTime = performance.now();
                state.lastTick = state.nextTickTime;
                scheduler();
            } else {
                clearTimeout(state.timerID);
            }
        }

        // 初始化
        initAudio().then(() => {
            // 事件绑定（保持原有旋转事件处理）
            document.getElementById('toggle').addEventListener('click', toggleMetronome);
        });

        // 移动端适配（保持原有触摸事件处理）
    </script>

       
</body>
</html>
