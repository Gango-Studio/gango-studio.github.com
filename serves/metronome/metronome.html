<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高精度兼容节拍器</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f5f5f5;
            font-family: Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        .wheel-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 30px;
        }

        .control-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            box-shadow: 8px 8px 16px #d9d9d9,
                      -8px -8px 16px #ffffff;
            cursor: pointer;
            touch-action: none;
            transition: transform 0.1s ease-out;
        }

        .center-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background: #f8f8f8;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 3px 3px 6px #d9d9d9,
                      inset -3px -3px 6px #ffffff;
        }

        #bpm {
            font-size: 1.8em;
            font-weight: bold;
            color: #444;
        }

        button {
            margin: 20px;
            padding: 12px 30px;
            font-size: 1.1em;
            cursor: pointer;
            background: #f0f0f0;
            border: none;
            border-radius: 25px;
            box-shadow: 4px 4px 8px #d9d9d9,
                      -4px -4px 8px #ffffff;
            color: #444;
            transition: all 0.2s ease;
        }

        button:active {
            box-shadow: inset 2px 2px 4px #d9d9d9,
                      inset -2px -2px 4px #ffffff;
        }
    </style>
</head>
<body>
    <div class="wheel-container">
        <div class="control-wheel"></div>
        <div class="center-display">
            <span id="bpm">120</span>
            <span>BPM</span>
        </div>
    </div>
    <button id="toggle">Start</button>

    <script>
        // 节拍器核心配置
        const config = {
            minBpm: 30,
            maxBpm: 240,
            baseBpm: 120,
            audioPoolSize: 3,
            sensitivity: 0.7
        };

        // 节拍器状态
        let state = {
            isPlaying: false,
            rotation: 0,
            currentBpm: config.baseBpm,
            nextTickTime: 0,
            audioIndex: 0,
            timeoutId: null
        };

        // 初始化音频池
        const audioPool = Array(config.audioPoolSize).fill().map(() => {
            const audio = new Audio('metronome.wav');
            audio.preload = 'auto';
            return audio;
        });

        // DOM元素引用
        const elements = {
            wheel: document.querySelector('.control-wheel'),
            bpmDisplay: document.getElementById('bpm'),
            toggleBtn: document.getElementById('toggle')
        };

        // 事件处理
        let isDragging = false;
        let lastAngle = 0;

        // 通用坐标获取
        function getPosition(event) {
            return event.touches ? {
                x: event.touches[0].clientX,
                y: event.touches[0].clientY
            } : {
                x: event.clientX,
                y: event.clientY
            };
        }

        // 旋转控制逻辑
        function handleDragStart(event) {
            event.preventDefault();
            isDragging = true;
            const rect = elements.wheel.getBoundingClientRect();
            const center = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
            const pos = getPosition(event);
            lastAngle = Math.atan2(pos.y - center.y, pos.x - center.x);
        }

        function handleDragMove(event) {
            if (!isDragging) return;
            event.preventDefault();

            const rect = elements.wheel.getBoundingClientRect();
            const center = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
            const pos = getPosition(event);
            const currentAngle = Math.atan2(pos.y - center.y, pos.x - center.x);
            
            const angleDiff = currentAngle - lastAngle;
            state.rotation += angleDiff * (180 / Math.PI);
            state.rotation %= 360;
            
            updateBpm(config.baseBpm + state.rotation * config.sensitivity);
            elements.wheel.style.transform = `rotate(${state.rotation}deg)`;
            
            lastAngle = currentAngle;
        }

        function handleDragEnd() {
            isDragging = false;
        }

        // BPM更新
        function updateBpm(newBpm) {
            state.currentBpm = Math.max(config.minBpm, 
                Math.min(config.maxBpm, Math.round(newBpm)));
            elements.bpmDisplay.textContent = state.currentBpm;
        }

        // 节拍器核心
        function scheduleTick() {
            if (!state.isPlaying) return;

            const now = performance.now();
            const interval = 60000 / state.currentBpm;
            
            // 时间补偿逻辑
            while (state.nextTickTime <= now + 100) {
                const targetTime = state.nextTickTime;
                state.nextTickTime += interval;
                
                const delay = Math.max(0, targetTime - performance.now());
                setTimeout(playAudio, delay);
            }

            requestAnimationFrame(scheduleTick);
        }

        // 音频播放
        function playAudio() {
            try {
                const audio = audioPool[state.audioIndex];
                audio.currentTime = 0;
                audio.play().catch(() => {});
                state.audioIndex = (state.audioIndex + 1) % config.audioPoolSize;
            } catch(e) {
                console.error('播放错误:', e);
            }
        }

        // 控制切换
        function toggleMetronome() {
            state.isPlaying = !state.isPlaying;
            elements.toggleBtn.textContent = state.isPlaying ? 'Stop' : 'Start';
            
            if (state.isPlaying) {
                state.nextTickTime = performance.now();
                scheduleTick();
            } else {
                cancelAnimationFrame(state.timeoutId);
            }
        }

        // 事件绑定
        elements.wheel.addEventListener('mousedown', handleDragStart);
        elements.wheel.addEventListener('touchstart', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('touchmove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        document.addEventListener('touchend', handleDragEnd);
        elements.toggleBtn.addEventListener('click', toggleMetronome);

        // 阻止触摸滚动
        document.body.addEventListener('touchmove', (e) => {
            if(isDragging) e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
